# Clarissa AI - Fastlane Configuration
# Automated screenshot capture and framing for App Store

default_platform(:ios)

# Shared configuration - use absolute paths to avoid directory confusion
FASTLANE_DIR = File.dirname(__FILE__)
PROJECT_DIR = File.expand_path("..", FASTLANE_DIR)
SCREENSHOT_OUTPUT = File.join(FASTLANE_DIR, "screenshots")
PROJECT_PATH = File.join(PROJECT_DIR, "Clarissa.xcodeproj")

platform :ios do
  desc "Capture iOS screenshots via UI tests"
  lane :screenshots do
    # Use xcodebuild directly due to fastlane compatibility issues with Xcode 26 beta
    devices = [
      "iPhone 17 Pro Max",
      "iPhone 17 Pro",
      "iPad Pro 13-inch (M5)"
    ]

    # Setup cache directory for SnapshotHelper
    home_dir = ENV["HOME"]
    cache_dir = File.join(home_dir, "Library/Caches/tools.fastlane")
    screenshots_cache = File.join(cache_dir, "screenshots")

    # Clear and prepare directories
    FileUtils.rm_rf(SCREENSHOT_OUTPUT) if File.directory?(SCREENSHOT_OUTPUT)
    FileUtils.mkdir_p(SCREENSHOT_OUTPUT)
    FileUtils.rm_rf(screenshots_cache) if File.directory?(screenshots_cache)
    FileUtils.mkdir_p(screenshots_cache)

    # Write language and locale files for SnapshotHelper
    File.write(File.join(cache_dir, "language.txt"), "en")
    File.write(File.join(cache_dir, "locale.txt"), "en_US")

    # Set environment variable that SnapshotHelper needs
    ENV["SIMULATOR_HOST_HOME"] = home_dir

    devices.each do |device|
      UI.message("Capturing screenshots on #{device}...")

      # Run xcodebuild with proper environment
      sh(
        "xcodebuild -scheme ClarissaUITests -project #{PROJECT_PATH} " \
        "-destination 'platform=iOS Simulator,name=#{device}' " \
        "-testLanguage en -testRegion US " \
        "build test 2>&1 || true"
      )

      UI.success("Completed #{device}")
    end

    # Copy screenshots from cache to output directory organized by device
    UI.message("Organizing screenshots from #{screenshots_cache}...")
    screenshot_count = 0
    Dir.glob(File.join(screenshots_cache, "*.png")).each do |file|
      filename = File.basename(file)
      UI.message("Found screenshot: #{filename}")
      # Filename format: "DeviceName-XX-ScreenshotName.png" where XX is 2 digits
      if filename =~ /^(.+)-(\d{2}-.+)\.png$/
        device_name = $1
        screenshot_name = $2
        device_dir = File.join(SCREENSHOT_OUTPUT, "en-US", device_name)
        FileUtils.mkdir_p(device_dir)
        FileUtils.cp(file, File.join(device_dir, "#{screenshot_name}.png"))
        screenshot_count += 1
      end
    end

    if screenshot_count == 0
      UI.important("No screenshots were captured. Check that UI tests are running correctly.")
    else
      UI.success("#{screenshot_count} screenshots saved to #{SCREENSHOT_OUTPUT}")
    end
  end

  desc "Add device frames and marketing text to iOS screenshots"
  lane :frame do
    frame_screenshots(
      path: SCREENSHOT_OUTPUT,
      white: false
    )
  end

  desc "Full iOS workflow: capture + frame"
  lane :marketing do
    screenshots
    frame
  end
end

platform :mac do
  desc "Capture macOS screenshots via UI tests"
  lane :screenshots do
    # Use xcodebuild directly due to fastlane compatibility issues with Xcode 26 beta

    # Setup cache directories for SnapshotHelper
    # Primary: user's home directory cache
    home_dir = ENV["HOME"]
    cache_dir = File.join(home_dir, "Library/Caches/tools.fastlane")
    screenshots_cache = File.join(cache_dir, "screenshots")
    # Fallback: /tmp for sandboxed apps
    tmp_cache_dir = "/tmp/tools.fastlane"
    tmp_screenshots_cache = File.join(tmp_cache_dir, "screenshots")

    FileUtils.mkdir_p(screenshots_cache)
    FileUtils.mkdir_p(tmp_screenshots_cache)

    # Write language and locale files for SnapshotHelper (in both locations)
    File.write(File.join(cache_dir, "language.txt"), "en")
    File.write(File.join(cache_dir, "locale.txt"), "en_US")
    File.write(File.join(tmp_cache_dir, "language.txt"), "en")
    File.write(File.join(tmp_cache_dir, "locale.txt"), "en_US")

    # Set environment variable (macOS SnapshotHelper uses HOME directly)
    ENV["SIMULATOR_HOST_HOME"] = home_dir

    UI.message("Capturing screenshots on Mac...")

    # Run xcodebuild for macOS
    sh(
      "xcodebuild -scheme ClarissaUITests -project #{PROJECT_PATH} " \
      "-destination 'platform=macOS' " \
      "build test 2>&1 || true"
    )

    # Copy Mac screenshots to output directory (check multiple locations)
    mac_output = File.join(SCREENSHOT_OUTPUT, "en-US", "Mac")
    FileUtils.mkdir_p(mac_output)

    screenshot_count = 0

    # UI test runner container fallback location
    container_cache = File.join(
      home_dir,
      "Library/Containers/dev.rye.ClarissaUITests.xctrunner/Data/tmp/fastlane_screenshots"
    )

    # Check all possible locations
    [screenshots_cache, tmp_screenshots_cache, container_cache].each do |cache_location|
      next unless File.directory?(cache_location)
      Dir.glob(File.join(cache_location, "Mac*.png")).each do |file|
        filename = File.basename(file)
        if filename =~ /^Mac-(.+)\.png$/
          FileUtils.cp(file, File.join(mac_output, "#{$1}.png"))
          screenshot_count += 1
          UI.message("Copied: #{filename} from #{cache_location}")
        end
      end
    end

    if screenshot_count == 0
      UI.important("No macOS screenshots were captured.")
    else
      UI.success("#{screenshot_count} macOS screenshots saved to #{mac_output}")
    end
  end

  desc "Add frames and marketing text to macOS screenshots"
  lane :frame do
    frame_screenshots(
      path: SCREENSHOT_OUTPUT,
      white: false
    )
  end

  desc "Full macOS workflow: capture + frame"
  lane :marketing do
    screenshots
    frame
  end
end

desc "Capture all screenshots (iOS + macOS)"
lane :screenshots_all do
  Fastlane::LaneManager.cruise_lane("ios", "screenshots")
  Fastlane::LaneManager.cruise_lane("mac", "screenshots")
end

desc "Frame all screenshots"
lane :frame_all do
  frame_screenshots(
    path: SCREENSHOT_OUTPUT,
    white: false
  )
end

desc "Full workflow: capture all + frame all"
lane :marketing_all do
  screenshots_all
  frame_all
end

desc "Copy screenshots to App Store directory"
lane :export do
  require 'fileutils'

  source = SCREENSHOT_OUTPUT
  dest = File.join(PROJECT_DIR, "screenshots")

  # Map fastlane device names to App Store directory structure
  # Using display sizes that match App Store Connect requirements
  mappings = {
    "iPhone 17 Pro Max" => "iPhone-6.9",
    "iPhone 17 Pro" => "iPhone-6.7",
    "iPad Pro 13-inch (M5)" => "iPad-13",
    "Mac" => "macOS"
  }

  total_copied = 0

  mappings.each do |device, folder|
    device_dir = File.join(source, "en-US", device)
    target_dir = File.join(dest, folder)

    next unless File.directory?(device_dir)

    FileUtils.mkdir_p(target_dir)

    # Try framed screenshots first, fall back to raw screenshots
    framed_files = Dir.glob(File.join(device_dir, "*_framed.png"))

    if framed_files.any?
      framed_files.each do |file|
        basename = File.basename(file).gsub(/_framed/, "")
        FileUtils.cp(file, File.join(target_dir, basename))
        total_copied += 1
      end
      UI.success("Copied #{framed_files.count} framed screenshots to #{target_dir}")
    else
      # Copy raw screenshots if no framed versions exist
      raw_files = Dir.glob(File.join(device_dir, "*.png"))
      raw_files.each do |file|
        basename = File.basename(file)
        FileUtils.cp(file, File.join(target_dir, basename))
        total_copied += 1
      end
      UI.success("Copied #{raw_files.count} raw screenshots to #{target_dir}")
    end
  end

  UI.important("Total: #{total_copied} screenshots exported to #{dest}")
end

